name: è‡ªåŠ¨ç”Ÿæˆ Sing-box è§„åˆ™

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # ä¹Ÿå¯ä»¥è®¾ç½®å®šæ—¶è§¦å‘ï¼Œä¾‹å¦‚æ¯å‘¨ä¸€å‡Œæ™¨ 0 ç‚¹
  # schedule:
  #   - cron: '0 0 * * 1'
  
jobs:
  convert_and_commit:
    runs-on: ubuntu-latest
    permissions:
      # æˆäºˆ Actions å†™å…¥æƒé™ï¼Œä»¥ä¾¿æäº¤æ–‡ä»¶
      contents: write 

    steps:
      # 1. æ£€å‡ºæ‚¨çš„ä»“åº“
      - name: Checkout Repository
        uses: actions/checkout@v4
        # ç¨€ç–æ£€å‡ºä»…é€‚ç”¨äº checkout v4 åŠä»¥ä¸Šç‰ˆæœ¬
        with:
          # å¯ç”¨ç¨€ç–æ£€å‡º
          sparse-checkout: |
            v2fly2singbox.py
            # ç¡®ä¿è„šæœ¬æœ¬èº«ä¹Ÿè¢«æ£€å‡º
            
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3. å¿«é€Ÿæ‹‰å–è§„åˆ™æ–‡ä»¶ (ä½¿ç”¨æµ…å…‹éš†+ç¨€ç–æ£€å‡º)
      - name: Clone domain-list-community data (Sparse Checkout)
        run: |
          # å…‹éš† v2fly/domain-list-community ä»“åº“
          git clone --depth 1 --filter=blob:none --sparse \
            https://github.com/v2fly/domain-list-community.git
          
          # è¿›å…¥å…‹éš†çš„ä»“åº“ç›®å½•
          cd domain-list-community
          
          # æŒ‡å®šåªä¸‹è½½ data/ ç›®å½•çš„å†…å®¹
          git sparse-checkout set data/
          
          # æ›´æ–° sparse-checkoutï¼Œæ­£å¼ä¸‹è½½ data ç›®å½•å†…å®¹
          git pull origin main

          # è¿”å›è„šæœ¬è¿è¡Œç›®å½•
          cd ..

      # 4. è¿è¡Œæ‚¨çš„ Python è„šæœ¬
      - name: Run Converter Script
        # è„šæœ¬å°†è¯»å– ./domain-list-community/data/google
        # å¹¶ç”Ÿæˆ ./google.json
        run: python v2fly2singbox.py
        
      # 5. æäº¤ç”Ÿæˆçš„ JSON æ–‡ä»¶
      - name: Commit generated file (google.json)
        # ä½¿ç”¨ stefanzweifel/git-auto-commit-action è‡ªåŠ¨æäº¤å˜æ›´
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ğŸ¤– Auto: Update sing-box rule (google.json)'
          files: 'google.json'
          # å¦‚æœæ‚¨ä½¿ç”¨äº† GitHub Tokenï¼Œè¿™é‡Œå¯ä»¥çœç•¥ï¼Œå› ä¸º contents: write æƒé™å·²ç»èµ‹äºˆ
          # commit_user_name: 'github-actions[bot]'
          # commit_user_email: 'github-actions[bot]@users.noreply.github.com'
